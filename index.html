require([
    "esri/layers/FeatureLayer",
    "esri/rest/query",
    "esri/rest/support/Query",
    "esri/identity/IdentityManager",
    "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
], function (FeatureLayer, query, Query, esriId, jsPDFModule) {
    
    // Get token from the dashboard context
    let token = null;
    
    // Try to get token from parent dashboard
    try {
        if (window.parent && window.parent.require) {
            window.parent.require(["esri/identity/IdentityManager"], function(parentEsriId) {
                const credentials = parentEsriId.credentials;
                if (credentials && credentials.length > 0) {
                    token = credentials[0].token;
                }
            });
        }
    } catch (e) {
        console.log("Could not access parent token, will try alternative methods");
    }

    async function generateReport() {
        try {
            statusDiv.textContent = '';
            buttonText.textContent = 'Generating...';
            loadingSpinner.style.display = 'inline-block';
            exportBtn.disabled = true;

            const layerUrl = "https://services1.arcgis.com/VVapzOPgBae5joyC/arcgis/rest/services/MDC_Field_Work_Database/FeatureServer/0";

            // Create layer with token if available
            const layerConfig = { url: layerUrl };
            if (token) {
                layerConfig.apiKey = token; // or use customParameters: { token: token }
            }

            const featureLayer = new FeatureLayer(layerConfig);

            const queryParams = new Query({
                where: "1=1",
                outFields: ["PARENT_Premise_Address"],
                returnGeometry: false
            });

            const results = await featureLayer.queryFeatures(queryParams);
            await createPDF(results.features);
            statusDiv.textContent = 'Report generated successfully!';
            
        } catch (error) {
            console.error('Error generating report:', error);
            statusDiv.textContent = 'Error generating report. Please try again.';
        } finally {
            buttonText.textContent = 'Generate PDF Report';
            loadingSpinner.style.display = 'none';
            exportBtn.disabled = false;
        }
    }
    
    // Rest of your code remains the same...
});
